---
title: “Configuration System for the RNA-seq Project”
author: "David Martín-Gálvez"
date: today
format:
  html: 
    theme: default
    toc: true
    number-sections: true
    embed-resources: true
editor: source
execute: 
  eval: false
  echo: true
---

# 1. Introduction

This document describes the **configuration system** for a RNA‑seq project. It implements:

* Separation of **shared configuration** and **machine-specific configuration**.
* A **portable path system** based on `BASE_DIR` and `REPO_DIR`.
* A repository that stores **scripts and configuration only**, never large data.
* A project structure designed for use on **macOS**, **cluster HOME**, **fstrat**, and **NAS**.

The configuration system consists of:

* `config.yaml` → *shared*, versioned configuration; same for all users and machines.
* `config_local.yaml` → *private*, unversioned configuration; machine-specific.
* `load_config.sh` → loader that reads both YAML files with `yq` and exposes variables to Bash/SLURM.

This ensures complete reproducibility, portability, and clarity.

---

# 2. Repository Structure

```
RNAseq_Gorriones_UGR_repo/
│
├── config/
│   ├── config.yaml              # Shared, versioned, portable paths
│   └── config_local.yaml        # Local-only, ignored by Git
│
├── scripts/
│   ├── bash/                    # One-sample scripts
│   ├── slurm/                   # Job submission wrappers
│   └── utils/
│       └── load_config.sh       # Loads YAML configuration
│
└── docs/
    └── config_system.qmd
```

This repository contains **no data** and **no results**.

---

# 3. `config.yaml` (Shared, Versioned)

Path: `config/config.yaml`


This file contains **only relative paths** and **pipeline parameters**, never absolute paths.

``` {yaml}
paths:
  fastq_raw:      "1_DATA/FASTQ/RAW"
  fastq_clean:    "1_DATA/FASTQ/CLEAN"
  reference:      "1_DATA/REFERENCE"
  analyses:       "2_ANALYSES"

cluster:
  threads: 8
  memory: "32G"
  queue: "short"
```

### Key rules

* No absolute paths.
* Stable across macOS, HOME, fstrat, NAS.
* Versioned in Git.

---

# 4. `config_local.yaml` (Machine‑Specific, Not Versioned)

Path: `config/config_local.yaml`

Examples:

### macOS

``` {yaml}
base_dir: "/Users/david/RNAseq_Gorriones_UGR"
repo_dir: "/Users/david/Repositories/RNAseq_Gorriones_UGR_repo"
```

### Cluster HOME

``` {yaml}
base_dir: "/mnt/home/users/.../RNAseq_Gorriones_UGR"
repo_dir: "/mnt/home/users/.../RNAseq_Gorriones_UGR_repo"
```

### fstrat (execution workspace)

```{yaml}
base_dir: "/fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209"
repo_dir: "/mnt/home/users/dba_001_uma/dmartin/RNAseq_Gorriones_UGR_repo"
```

### Add to `.gitignore`:

```
config/config_local.yaml
```

``` {bash}
echo "config/config_local.yaml" >> .gitignore
```

_This file must never be committed._

---

# 5. `load_config.sh` – Merging Both Configurations

Path: `scripts/utils/load_config.sh`

``` {bash}
#!/bin/bash

MAIN_CONFIG="config/config.yaml"
LOCAL_CONFIG="config/config_local.yaml"

if [[ ! -f "$MAIN_CONFIG" ]]; then
    echo "ERROR: Missing config.yaml" >&2; exit 1
fi
if [[ ! -f "$LOCAL_CONFIG" ]]; then
    echo "ERROR: Missing config_local.yaml" >&2; exit 1
fi

# Machine-specific base directory
BASE_DIR=$(yq -r '.base_dir' "$LOCAL_CONFIG")
REPO_DIR=$(yq -r '.repo_dir' "$LOCAL_CONFIG")

# Relative paths from config.yaml
RAW_REL=$(yq -r '.paths.fastq_raw' "$MAIN_CONFIG")
CLEAN_REL=$(yq -r '.paths.fastq_clean' "$MAIN_CONFIG")
REF_REL=$(yq -r '.paths.reference' "$MAIN_CONFIG")
ANALYSES_REL=$(yq -r '.paths.analyses' "$MAIN_CONFIG")

# Build absolute paths
FASTQ_RAW_DIR="$BASE_DIR/$RAW_REL"
FASTQ_CLEAN_DIR="$BASE_DIR/$CLEAN_REL"
REFERENCE_DIR="$BASE_DIR/$REF_REL"
ANALYSES_DIR="$BASE_DIR/$ANALYSES_REL"

# Cluster parameters
THREADS=$(yq -r '.cluster.threads' "$MAIN_CONFIG")
MEMORY=$(yq -r '.cluster.memory' "$MAIN_CONFIG")
QUEUE=$(yq -r '.cluster.queue' "$MAIN_CONFIG")
```

---

# 6. Example Bash Script (One Sample) Using the Configuration

Path: `scripts/bash/01_fastqc_one_sample.sh`

``` {bash}
#!/bin/bash

SAMPLE_ID="$1"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$SCRIPT_DIR/../.."
cd "$REPO_ROOT" || exit 1

source scripts/utils/load_config.sh

OUTDIR="$ANALYSES_DIR/01_fastqc"
mkdir -p "$OUTDIR"

if command -v module &> /dev/null; then
    module load fastqc
else
    echo "FastQC: no module system in this environment"
fi

fastqc -t "$THREADS" -o "$OUTDIR" "$FASTQ_RAW_DIR/${SAMPLE_ID}"*.fastq.gz
```

This script performs FastQC on **one sample** only. It is independent of SLURM.

---

# 7 Sample list file

Generate a file listing sample identifiers from an md5sum file provided by the sequencing facility.

**Script location:** `config/extract_samples_names_md5sum.sh`

### What the script does

The script `extract_samples_names_md5sum.sh` extracts unique sample names from a **md5sum file** (typically provided by the sequencing facility) and creates a clean list for use in SLURM array jobs. 

**Key features:**

* **Flexible input:** Accepts a user-provided md5sum file as an argument, or auto-detects `md5sum*.txt` files in `FASTQ/RAW/`.
* **Robust parsing:** Uses AWK to parse md5sum file entries and extracts sample names from paired-end FASTQ filenames (handles `_1.fastq.gz` and `_2.fastq.gz` conventions).
* **Automatic deduplication:** Returns unique sample names, sorted alphabetically.
* **Clear output:** Saves results to `config/samples_names.txt` with informative logging.

### Usage

**Option 1: Auto-detect md5sum file in FASTQ/RAW/**

``` {bash}
bash config/extract_samples_names_md5sum.sh
```

The script searches for any `md5sum*.txt` file in `$FASTQ_RAW_DIR`.

**Option 2: Provide md5sum file explicitly**

``` {bash}
bash config/extract_samples_names_md5sum.sh /path/to/md5sum.txt
```

### Output

Produces a file `config/samples_names.txt` with one sample identifier per line:

```
SPARROW_001
SPARROW_002
SPARROW_003
SPARROW_004
SPARROW_005
```

Each line corresponds to one array task index.

---

# 8. Example SLURM Script (Array Job) Using the Configuration 

Job arrays allow parallel execution of the same task across multiple samples.
This project architecture supports job arrays cleanly because:

* **Bash scripts handle the logic** for processing *one sample*.
* **SLURM array scripts handle distribution** of work across samples.

This separation keeps code modular, testable on the Mac, and easily scalable on HPC.


Path: `scripts/slurm/01_fastqc_array.sbatch`

*** VOY POR AQUÍ ***
<!-- check template for slurm scripts -->


``` {bash}
#!/bin/bash
#SBATCH --job-name=fastqc_array
#SBATCH --output=%x_%A_%a.out
#SBATCH --error=%x_%A_%a.err
#SBATCH --cpus-per-task=4
#SBATCH --mem=8G
#SBATCH --time=01:00:00
#SBATCH --partition=short
#SBATCH --array=0-4

REPO_ROOT="$HOME/Repositories/RNAseq_Gorriones_UGR_repo"
cd "$REPO_ROOT" || exit 1

source scripts/utils/load_config.sh

SAMPLES_FILE="config/samples_fastqc.txt"
SAMPLE_ID=$(sed -n "$((SLURM_ARRAY_TASK_ID+1))p" "$SAMPLES_FILE")

echo "Processing: $SAMPLE_ID"

bash scripts/bash/01_fastqc_one_sample.sh "$SAMPLE_ID"
```

---

# 8. Storage Architecture (macOS, HOME, fstrat, NAS)

## Summary

* **macOS:** development, testing, documentation.
* **HOME:** repository + lightweight files.
* **fstrat:** high‑performance execution workspace.
* **NAS:** permanent project archive.

All scripts behave identically because they rely on **BASE_DIR** and **REPO_DIR**.

---

# 9. Final Project Structure (Stable on NAS and macOS)

```
RNAseq_Gorriones_UGR/
│
├── 1_DATA/
│   ├── FASTQ/
│   │   ├── RAW/
│   │   └── CLEAN/
│   ├── REFERENCE/
│   │   ├── GENOME/
│   │   ├── ANNOTATION/
│   │   └── INDEXES/
│   └── METADATA/
│
├── 2_ANALYSES/
│   ├── Scripts/        # symlink to repository scripts
│   ├── Results/        # outputs from pipeline steps
│   ├── 01_fastqc/
│   ├── 02_trimming/
│   ├── 03_alignment/
│   ├── 04_sort_index/
│   ├── 05_counts/
│   └── 06_DE/
│
├── 3_FIGURES/
├── 4_TABLES/
└── 5_PUBLICATION/
```

---

# 10. fstrat Execution Workspace (Per-Run)

Within each run directory, analyses are now organized into `Scripts` and `Results` for clarity and reproducibility:

```
/fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209/
│
├── 1_DATA/        # minimal replicated inputs
└── 2_ANALYSES/
    ├── Scripts/   # symlink to repository scripts
    └── Results/   # all outputs generated here
```

A symlink to the repository is created as:

``` {bash}
ln -s "$REPO_DIR/scripts" "$BASE_DIR/2_ANALYSES/Scripts/scripts_repo"
```

This ensures traceability without duplicating code.

# 10. (Per‑Run)

```
/fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209/
│
├── 1_DATA/        # Minimal replicated inputs
└── 2_ANALYSES/    # All outputs generated here
```

After execution:

``` {bash}
rsync -av /fstrat/.../2_ANALYSES/ /NAS/RNAseq_Gorriones_UGR/2_ANALYSES/
```

---

# 11. Final Notes

* Scripts never hard‑code paths.
* Only `BASE_DIR` and `REPO_DIR` differ between machines.
* All logic lives in `scripts/bash` and `scripts/slurm`.
* Data lives **outside** the repository, in the project directory.
* The system is fully portable across macOS ↔ HOME ↔ fstrat ↔ NAS.





----

ANTIGUOO COMPARAR CON VERSIÓN NUEVA

-----



## 8.3 SLURM script: distribute work via array

Path:

```
scripts/slurm/01_fastqc_array.sbatch
```

``` {bash}
#!/bin/bash
#SBATCH --job-name=fastqc_array
#SBATCH --output=%x_%A_%a.out
#SBATCH --error=%x_%A_%a.err
#SBATCH --cpus-per-task=4
#SBATCH --mem=8G
#SBATCH --time=01:00:00
#SBATCH --partition=short
#SBATCH --array=0-4     # Adjust based on number of samples

REPO_ROOT="$HOME/projects/RNAseq_Gorriones_UGR_repo"
cd "$REPO_ROOT" || exit 1

SAMPLES_FILE="config/samples_fastqc.txt"

# Get sample ID based on array index
SAMPLE_ID=$(sed -n "$((SLURM_ARRAY_TASK_ID+1))p" "$SAMPLES_FILE")

echo "Running FastQC for sample: $SAMPLE_ID (array task ID: $SLURM_ARRAY_TASK_ID)"

bash scripts/bash/01_fastqc_one_sample.sh "$SAMPLE_ID"
```

### How it works

* `SLURM_ARRAY_TASK_ID` provides an index starting at 0.
* `sed` extracts the corresponding line from the sample file.
* Each task launches the Bash script on a different sample.

Submit the job:

``` {bash}
sbatch scripts/slurm/01_fastqc_array.sbatch
```

---

## 8.4 Benefits of this design

* **Reusability**: Bash scripts can be tested locally or reused on different HPC systems.
* **Scalability**: SLURM arrays distribute samples efficiently.
* **Clean architecture**: No duplication of FastQC logic inside SLURM scripts.
* **Flexibility**: Changing sample lists does not require editing Bash or SLURM scripts.

---

# 9. Execution Environments and Storage Architecture

This project relies on a flexible storage system designed to support development on a local machine (macOS), execution on the HPC cluster (Picasso), and long-term archival storage on the NAS system. The configuration layer (`config.yaml` + `config_local.yaml`) allows the same scripts to run seamlessly across all environments by adjusting only two variables: `base_dir` and `repo_dir`.

---

## 9.1 Storage layers overview

The project uses **three distinct storage layers**, each with different performance and persistence characteristics:

### 1. **fstrat** (HPC high‑performance temporary storage)

* Fast, local to compute nodes.
* Intended for **pipeline execution**.
* Data here should be considered **temporary**.
* Ideal location for `base_dir` during analysis runs.

### 2. **HOME directory on the cluster**

* Persistent but slower than fstrat.
* Used primarily to store the **repository** (`repo_dir`) and optionally lightweight logs.
* Not suitable for large BAM/FASTQ files.

### 3. **NAS (Network Attached Storage)**

* Permanent archival storage.
* Stores the full project structure: raw data, clean data, final results, figures, tables, and manuscript files.
* Not used for computation due to slower I/O.

---

## 9.2 Directory structure in fstrat: per‑run execution workspace

To maximize performance, each analysis batch is executed inside a dedicated `run_*` folder in **fstrat**:

``` 
/fstrat/dmartin/RNAseq_Gorriones_UGR/
│
├── run_20251209_pilot1/
│   ├── 1_DATA/
│   │   ├── RAW/
│   │   ├── CLEAN/
│   │   ├── REFERENCE/
│   │   ├── BAM/
│   │   ├── BAMclean/
│   │   ├── COUNTS/
│   │   └── QC/
│   └── 2_ANALYSES/
│       └── Results/
│           ├── 01_fastqc/
│           ├── 02_trimming/
│           ├── 03_alignment/
│           ├── 04_sort_index/
│           ├── 05_counts/
│           └── 06_DE/
```

Scripts read and write entirely inside this directory, using paths derived from `base_dir`.

**Example `config_local.yaml` for fstrat execution:**

``` {yaml}
base_dir: "/fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209_pilot1"
repo_dir: "/mnt/home/users/dba_001_uma/dmartin/projects/RNAseq_Gorriones_UGR_repo"
```

This allows full pipeline execution without modifying any script.

---

## 9.3 Directory structure on the NAS: long‑term project storage

The NAS hosts the permanent, curated version of the project:

```
/NAS/RNAseq_Gorriones_UGR/
│
├── 0_ADMIN/
├── 1_DATA/
├── 2_ANALYSES/
├── 3_FIGURES/
├── 4_TABLES/
└── 5_PUBLICATION/
```

The NAS is **not used for computation**. Instead, files are synchronised from fstrat after each run.

---

## 9.4 Directory structure on macOS

Used for development, small test runs, and documentation:

``` {yaml}
# config_local.yaml on macOS
base_dir: "/Users/david/.../RNAseq_Gorriones_UGR"
repo_dir: "/Users/david/.../RNAseq_Gorriones_UGR_repo"
```

This enables fully consistent behaviour of scripts across laptops, HPC, and NAS.

---

## 9.5 Synchronising results from fstrat to NAS

After a run completes in fstrat, relevant outputs are synchronised to NAS using `rsync`:

``` {bash}
# Sync analysis results back to NAS
rsync -av \
  /fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209_pilot1/2_ANALYSES/Results/ \
  /NAS/RNAseq_Gorriones_UGR/2_ANALYSES/Results/

# Sync cleaned FASTQ files if needed
rsync -av \
  /fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209_pilot1/1_DATA/CLEAN/ \
  /NAS/RNAseq_Gorriones_UGR/1_DATA/CLEAN/
```

This pattern allows:

* Fast execution on the cluster.
* Durable storage on the NAS.
* Clean reproducibility thanks to consistent configuration.

---

## 9.6 Summary of environment‑dependent configuration

Only two variables change across machines:

``` {yaml}
base_dir: "path/to/data_and_results"   # fstrat on cluster, NAS or local path on macOS
repo_dir: "path/to/repository"         # HOME on cluster, local path on macOS
```

All scripts use these paths indirectly through `load_config.sh`, ensuring portability and reproducibility.

---

## 9.7 Revised DATA and ANALYSES Directory Structure

A clear separation between **data** and **analysis results** is essential for reproducibility, auditability, and long-term project organization. This section documents the recommended structure for `1_DATA` and `2_ANALYSES`, following bioinformatics best practices and ensuring compatibility with execution on macOS, HOME, fstrat, and NAS.

---

## 10.1 Rationale: Why DATA and ANALYSES must be separated

Data and results serve different purposes and must not be intermingled:

### **DATA (`1_DATA/`)**

* Contains **inputs** to the pipeline.
* Includes stable, version-controlled datasets.
* Should not be overwritten during analyses.
* Represents the "truth" of the experiment.

### **ANALYSES (`2_ANALYSES/`)**

* Contains **outputs** generated by scripts.
* May be regenerated at any time.
* Includes intermediate files (e.g., BAMs), logs, stats, and final results.
* Can be safely deleted or recomputed.

This separation allows:

* Clear provenance of results.
* Multiple runs (`run_...`) without duplicating input data.
* Clean HPC workflow: DATA copied from NAS → ANALYSES produced in fstrat → results synchronised back.

---

## 10.2 Recommended structure for `1_DATA/` (inputs only)

`1_DATA/` should contain only stable input datasets and supporting metadata. No files generated by the pipeline should be stored here.

```
1_DATA/
│
├── FASTQ/
│   ├── RAW/              # FASTQ files delivered by the sequencing provider
│   └── CLEAN/            # Optional: trimmed FASTQ, if stored as stable derived data
│
├── REFERENCE/
│   ├── GENOME/           # Reference FASTA, sequence dictionary
│   ├── ANNOTATION/       # GTF/GFF3 annotation files
│   └── INDEXES/          # STAR, HISAT2, kallisto, Salmon indices
│
└── METADATA/
    ├── sample_sheet.csv
    ├── library_info.csv
    └── sequencing_run_info/
```

Notes:

* If trimmed FASTQ are expected to change (e.g., parameter tuning), they should NOT be stored in `1_DATA/`. Instead, place them in `2_ANALYSES` under the trimming step.
* The REFERENCE directory remains stable and is copied or linked into fstrat.

---

## 10.3 Recommended structure for `2_ANALYSES/` (pipeline outputs)

All computational results, from QC to differential expression, should be stored under `2_ANALYSES/`. Each step of the pipeline gets its own subdirectory, including logs and intermediate files.

```
2_ANALYSES/
│
├── 01_fastqc/
│   ├── RAW/
│   └── CLEAN/
│
├── 02_trimming/
│   ├── CLEAN_FASTQ/
│   └── LOGS/
│
├── 03_alignment/
│   ├── BAM/
│   ├── STATS/
│   └── LOGS/
│
├── 04_sort_index/
│   ├── BAM_clean/
│   └── LOGS/
│
├── 05_counts/
│   ├── RAW/
│   ├── NORMALIZED/
│   └── QC/
│
└── 06_DE/
    ├── tables/
    ├── plots/
    ├── logs/
    └── metadata/
```

Advantages of this structure:

* Clear mapping of each pipeline step.
* Easy removal/recomputation of analysis outputs.
* BAM files and similar large intermediates do not pollute the `DATA` directory.
* Supports versioned multi-run workflows (e.g., `run_20251209`, `run_20260115`).

---

## 10.4 Application in fstrat: fast temporary workspace

During execution on the cluster, analyses are stored inside a designated `run_*` folder in fstrat:

```
/fstrat/dmartin/RNAseq_Gorriones_UGR/run_20251209/
│
├── 1_DATA/            # minimally replicated inputs (FASTQ RAW, reference)
└── 2_ANALYSES/        # all pipeline outputs
```

At the end of the run, results are synchronised to the NAS:

``` {bash}
rsync -av \
  /fstrat/dmartin/.../run_20251209/2_ANALYSES/ \
  /NAS/RNAseq_Gorriones_UGR/2_ANALYSES/
```

This preserves high I/O performance during execution while keeping permanent storage clean and reproducible.

---

## 10.5 Implications for configuration (`config.yaml`)

Using this structure, path variables in `config.yaml` become clear and unambiguous. Example:

```{yaml}
fastq_raw_dir:      "${BASE_DIR}/1_DATA/FASTQ/RAW"
fastq_clean_dir:    "${BASE_DIR}/1_DATA/FASTQ/CLEAN"
reference_dir:      "${BASE_DIR}/1_DATA/REFERENCE"
alignment_out_dir:  "${BASE_DIR}/2_ANALYSES/03_alignment/BAM"
counts_out_dir:     "${BASE_DIR}/2_ANALYSES/05_counts/RAW"
```

Scripts remain portable across macOS, cluster HOME, fstrat, and NAS, since only `BASE_DIR` changes across environments.

---

# 10. Summary

* `config.yaml` → shared, versioned, general settings.
* `config_local.yaml` → local, private, machine-specific.
* `load_config.sh` → merges both and exposes variables.
* All scripts use `source load_config.sh` for consistent paths.
* Ensures full reproducibility, separation of concerns, and portability.




---
---
---